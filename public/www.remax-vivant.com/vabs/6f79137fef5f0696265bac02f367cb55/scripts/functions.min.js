var check = 0;

$(function () {
	/* BADGE AS */
	//showBadge("as");
	M4TCvalidator.init();

	// $("#txLocalidade,#txConsultorio").msDropDown({
	// 	mainCSS: "dd"
	// });

	if (navigator.userAgent.indexOf('MSIE') !== -1 ) {
   // MSIE

	$('[placeholder]').focus(function() {
		var input = $(this);
		if (input.val() == input.attr('placeholder')) {
			input.val('');
			input.removeClass('placeholder');
		}
	}).blur(function() {
		var input = $(this);
		if (input.val() == '' || input.val() == input.attr('placeholder')) {
			input.addClass('placeholder');
			input.val(input.attr('placeholder'));
		}
	}).blur();
	$('[placeholder]').parents('form').submit(function() {
		$(this).find('[placeholder]').each(function() {
			var input = $(this);
			if (input.val() == input.attr('placeholder')) {
				input.val('');
			}
		});
	});
}

	///////////////////////////////////////////////////////////////
	$(document).ajaxStart(function() {
		$("#submitFirst").hide();
		$("#loader").show();
	});
	$(document).ajaxStop(function() {
		$("#loader").hide();
		$("#submitFirst").show();
	});
	///////////////////////////////////////////////////////////////

    $(".sectionbtn, .locationcta").click(function(e){
        focusForm ();
        $('html, body').animate({
            scrollTop:(0)
        }, 500,function(){

        });
        return false;

    });

    $("#txName, #thPhone, #txEmail").on ("focus", function ()
    {
        funnelTracker ("startForm", true);
    });

    $("#txLocation, #txAmmount").on ("focus", function ()
    {
        funnelTracker ("startSecondForm", true);
    });

    $("input").on ("focus", function ()
    {
        focusForm ();
    });

    $("#fader").on ("click", function ()
    {
        blurForm ();
    });

    function focusForm ()
    {
        $('#fader').show ();
        $('#fader').animate ({opacity:.6});
    }

    function blurForm ()
    {
        $('#fader').animate ({opacity:0}, function ()
        {
            $('#fader').hide ();
        });
    }

    /*
	$("#txNumber").keyup(function(){
		if($(this).val().length == 2){
			if ($(this).val().substring(0,2) == '20'){
				$("#txNumber").attr("minlength","11").attr("maxlength","11");
			}else if ($(this).val().substring(0,2) == '07'){
				$("#txNumber").attr("minlength","10").attr("maxlength","10");
			}
		}
	});

	$.validator.addMethod('phone_UK', function(value, element, arg) {
		if (value.substring(0,2) == '20' || value.substring(0,2) == '07'){
						return true;
					}else{
						return false;
					}
						
				}, $.validator.format('Introduzca correctament su Telefóno'));
     */

    $.validator.addMethod('phone_FR', function(value, element, arg) {
        if (this.optional(element)) {return true;}

        var reg = new RegExp('^0[1-7]{1}(([0-9]{2}){4})|((\s[0-9]{2}){4})|((-[0-9]{2}){4})$', 'i');

        return reg.test(value);

    }, $.validator.format('Numéro'));


	//GUARDAR E-MAIL e E-MAIL TAGS
	$.ajax({
		url: "calls/emailDomains.php",
		dataType: "json",
		success: function(data) {
			availableTags = data.domains;
		}
	});

	$("#txEmail").autocomplete({
		source: availableTags
	});

	$("#txEmail").keyup(function(event) {
		if (availableTags !== undefined) {
			if (event.target.value.indexOf("@") == -1) {
				var new_options = [];
				for (var i = 0; i < availableTags.length; i++)
					new_options[i] = $(this).val() + availableTags[i];
				$(this).autocomplete("option", "source", new_options);
			}
		}
	});

	$("#step1").validate({
		rules: {
            txName: {
				required: true,
				nome_apelido: true
			},
            txPhone: {
				required:true,
                phone_FR:true,
                maxlength:$("#txPhone").attr("maxlength"),
                minlength:$("#txPhone").attr("minlength")
			},
            txEmail:{
				required:true,
                email:true,
                remote:'calls/ASMailChecker.php'
			}
		},
		messages: {
            txName: {
				required: "Saisissez votre Nom et Prénom",
				nome_apelido: "Saisissez votre Nom et Prénom"
			},
            txPhone:{
				required:"Saisissez votre Numéro de téléphone",
                phone_PT:"Saisissez votre Numéro de téléphone",
                maxlength:"Saisissez votre Numéro de téléphone {0}",
                minlength:"Saisissez votre Numéro de téléphone {0}"
			},
            txEmail:{
				required:"Saisissez votre e-mail",
                email:"Saisissez votre e-mail",
                remote:"Saisissez votre e-mail"
			}
		},
		debug: true,
		onfocusout:false,
		onkeyup:false,
		onclick:false,
		invalidHandler: function(){
			$("#errorLabel").animate({opacity:1,height:'25px'},200);
			$("input.error").css("background","#fbcbcb");
			$("input.valid").css("background","#c0fdc5");
		},
     	submitHandler: function(form) {
	        //$("#errorLabel").animate({opacity:0,height:'0px'},200);
	       	//$('#form3').show();
            $("#submitFirst").attr ("disabled", "disabled");
            $("#submitFirst").val ($("#submitFirst").data ("wait"));
            checkForm (form);
   		 },
		success:function(label){
			if($("#step1 input.error").length === 0 && $("#step1 select.error").length === 0){
                $("#submitFirst").show ();
				$("#errorLabel").animate({opacity:0,height:'0px'},200);
				$("input.error").css("background","#fbcbcb");
				$("input.valid").css("background","#c0fdc5");
			}
		},
		errorPlacement: function (error, element) {},
		showErrors: function(errorMap, errorList){
			this.defaultShowErrors();
			if(errorList.length) {
				$("#errorLabel").html(errorList[0].message).show();
				$("input.error").css("background","#fbcbcb");
				$("input.valid").css("background","#c0fdc5");
			}
		}
	});

	$("#step2").validate({
			rules: {
                txLocation: {
					required:true
				},
                txAmmount:{
					required:true
				}
			},
			messages: {
                txLocation: {
                    required: "Saisissez votre Emplacement"
				},
                txAmmount:{
                    required:"Saisissez votre Montant à investir"
				}
			},
			debug: true,
			onfocusout:false,
			onkeyup:false,
			onclick:false,
			invalidHandler: function(){
				$("#errorLabel2").animate({opacity:1,height:'auto'},200);
				$("input.error").css("background","#fbcbcb");
				$("input.valid").css("background","#c0fdc5");
			},
	     	submitHandler: function(form)
            {
                $("#errorLabel2").animate({opacity:0,height:'0px'},200);
                $("#submit2").attr ("disabled", "disabled");
                $("#submit2").val ($("#submit2").data ("wait"));
	      	    checkForm(form);
	   		 },
			success:function(label){
				if($("#step2 input.error").length === 0 && $("#step2 select.error").length === 0){ 
					$("#errorLabel2").animate({opacity:0,height:'0px'},200);
					$("input.error").css("background","#fbcbcb");
					$("input.valid").css("background","#c0fdc5");
				}
			},
			errorPlacement: function (error, element) {},
			showErrors: function(errorMap, errorList){
				this.defaultShowErrors();
				if(errorList.length) {
					$("#errorLabel2").html(errorList[0].message).show();
					$("input.error").css("background","#fbcbcb");
					$("input.valid").css("background","#c0fdc5");
				}
			}
		});
	});

function checkForm(form){
	var formID ="#"+form.id;
	var formURL = "calls/" + form.id + ".php?"+urlparams;
	var formData = $(formID).serialize();
    if (formID == "#step1")
    {
        funnelTracker ("firstStepSend");
    }
    else if (formID == "#step2")
    {
        funnelTracker ("secondStepSend");
    }

	$.post(formURL, formData, function(data){
        if (formID == "#step1")
        {
            $("#conv").html(data.conv);
            if(data.message=="success")
            {
                funnelTracker ("firstStepSuccess", true);
                $("#nID").val (data.nID);
                $("#at_state").val (data.at_state);
                $("#txName_aux").val ($("#txName").val ());
                $("#txPhone_aux").val ($("#txPhone").val ());
                $("#txEmail_aux").val ($("#txEmail").val ());
                $("#formStep1").hide ();
                $("#formStep2").show ();
                $("#txLocation").focus ();
            }
            else
            {
                funnelTracker ("firstStepFail", true);
            }
        }
        else if (formID == "#step2")
        {
            $('#step2').hide();
            if(data.message=="success")
            {
                funnelTracker ("secondStepSuccess", true);
                $('.w-form-done').show();
            }
            else
            {
                funnelTracker ("secondStepFail", true);
                $(".w-form-fail").show ();
            }
        }
        return false;
    },"json");
}


$(function ()
{
    $("body").append ('<iframe id="funnelTracker" src="about:blank" width="1" height="1" style="position:absolute; left:-10000px; top:0;"></iframe>');
    window.lastCalledFunnelStep = "";
    window.funnelTracker = function (trackStepIdentifier_in, runOnceIfLastCalled)
    {
        if (lastCalledFunnelStep != trackStepIdentifier_in || !runOnceIfLastCalled)
            $("#funnelTracker").attr ("src", "calls/funnelTracker.php?" + trackStepIdentifier_in);
        lastCalledFunnelStep = trackStepIdentifier_in;
    }
})

